<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>MiniBook</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial; background:#f0f2f5; margin:0 }
.box { max-width:500px; margin:20px auto; background:#fff; padding:15px; border-radius:8px }
input, textarea, button { width:100%; margin:5px 0; padding:10px }
button { background:#1877f2; color:#fff; border:0; border-radius:5px }
.post { border-top:1px solid #ddd; padding:10px 0 }
img { max-width:100%; border-radius:8px }
</style>
</head>

<body>

<div id="auth" class="box">
  <h3>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ / Ø¯Ø®ÙˆÙ„</h3>
  <input id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
  <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
  <p id="msg"></p>
</div>

<div id="app" class="box" style="display:none">
  <h3 id="welcome"></h3>
  <textarea id="postText" placeholder="Ù…Ø§Ø°Ø§ ØªÙÙƒØ±ØŸ"></textarea>
  <input type="file" id="postImage">
  <button onclick="addPost()">Ù†Ø´Ø±</button>
  <button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  <div id="posts"></div>
</div>

<!-- Firebase CDN -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
/* ğŸ”‘ Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªÙƒ */
firebase.initializeApp({
  apiKey: "AIzaSyAiZsXpUfRB2s__oWRLjjT3yEgZQXOXIuI",
  authDomain: "book-ee927.firebaseapp.com",
  databaseURL: "https://book-ee927-default-rtdb.firebaseio.com",
  projectId: "book-ee927",
  storageBucket: "book-ee927.appspot.com",
});

const db = firebase.database();
const storage = firebase.storage();

let currentUser = localStorage.getItem("user");

/* ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
function login(){
  const name = username.value.trim();
  if(!name) return msg.innerText="Ø§ÙƒØªØ¨ Ø§Ø³Ù…";

  db.ref("users/"+name).get().then(snap=>{
    if(!snap.exists()){
      db.ref("users/"+name).set({name});
    }
    localStorage.setItem("user",name);
    start();
  });
}

/* ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
function start(){
  currentUser = localStorage.getItem("user");
  if(!currentUser) return;

  auth.style.display="none";
  app.style.display="block";
  welcome.innerText="Ù…Ø±Ø­Ø¨Ø§ "+currentUser;
  loadPosts();
}

/* Ø¥Ø¶Ø§ÙØ© Ø¨ÙˆØ³Øª */
function addPost(){
  const text = postText.value;
  const file = postImage.files[0];
  const id = Date.now();

  if(file){
    const ref = storage.ref("posts/"+id);
    ref.put(file).then(()=>{
      ref.getDownloadURL().then(url=>{
        savePost(text,url,id);
      });
    });
  }else{
    savePost(text,"",id);
  }
}

function savePost(text,img,id){
  db.ref("posts/"+id).set({
    user: currentUser,
    text,
    img
  });
  postText.value="";
}

/* Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙˆØ³ØªØ§Øª */
function loadPosts(){
  db.ref("posts").on("value",snap=>{
    posts.innerHTML="";
    snap.forEach(p=>{
      const d=p.val();
      posts.innerHTML+=`
      <div class="post">
        <b>${d.user}</b>
        <p>${d.text}</p>
        ${d.img?`<img src="${d.img}">`:""}
        ${d.user==currentUser?`<button onclick="delPost(${p.key})">Ø­Ø°Ù</button>`:""}
      </div>`;
    });
  });
}

/* Ø­Ø°Ù Ø¨ÙˆØ³Øª */
function delPost(id){
  db.ref("posts/"+id).remove();
}

/* Ø®Ø±ÙˆØ¬ */
function logout(){
  localStorage.clear();
  location.reload();
}

start();
</script>

</body>
</html>