<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini Facebook Full</title>
<style>
  body { font-family: Arial, sans-serif; background:#f0f2f5; margin:0; padding:0; }
  header { background:#4267B2; color:white; padding:10px; text-align:center; font-size:24px; }
  main { padding:20px; max-width:600px; margin:auto; }
  input, button, textarea { width:100%; padding:10px; margin:5px 0; border-radius:5px; border:1px solid #ccc; }
  button { background:#4267B2; color:white; border:none; cursor:pointer; }
  button:hover { background:#365899; }
  .post { background:white; padding:10px; margin:10px 0; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
  .post img { max-width:100%; border-radius:5px; margin-top:5px; }
  .username { font-weight:bold; color:#4267B2; display:flex; align-items:center; gap:10px; }
  .avatar { width:30px; height:30px; border-radius:50%; object-fit:cover; }
  .comments { margin-top:10px; padding-left:20px; border-left:2px solid #eee; }
  .comment { margin-bottom:5px; }
  .profile { text-align:center; margin-bottom:20px; }
  .profile img { width:80px; height:80px; border-radius:50%; object-fit:cover; cursor:pointer; }
  .feed-title { margin-top:20px; font-size:18px; }
  a { color:#4267B2; text-decoration:none; }
</style>
</head>
<body>
<header>Mini Facebook Full</header>
<main>

<div id="signupDiv">
  <h2>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h2>
  <input type="text" id="su_username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" required>
  <button onclick="signUp()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
</div>

<div id="profileDiv" style="display:none;">
  <div class="profile">
    <img id="profileAvatar" src="https://via.placeholder.com/80" onclick="editAvatar()">
    <h2 id="profileName"></h2>
    <p id="profileBio" onclick="editBio()"></p>
    <p><a href="#" onclick="showUserFeed(currentUser)">Ù…Ù†Ø´ÙˆØ±Ø§ØªÙŠ</a> | <a href="#" onclick="showFeed()">Feed Ø¹Ø§Ù…</a></p>
  </div>
  <h3>Ø£Ù†Ø´Ø¦ Ù…Ù†Ø´ÙˆØ±Ø§Ù‹</h3>
  <textarea id="postContent" placeholder="Ø§ÙƒØªØ¨ Ø´ÙŠØ¦Ø§Ù‹..."></textarea>
  <input type="text" id="postImage" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
  <button onclick="createPost()">Ù†Ø´Ø±</button>

  <h3 id="feedTitle" class="feed-title">Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª</h3>
  <div id="feed"></div>
  <button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>

<script src="https://unpkg.com/parse/dist/parse.min.js"></script>
<script>
Parse.initialize("ud7pjwTspM89k8GtFzMi4eppYn62HqXqNKQsbHsd"); // App ID
Parse.serverURL = "https://parseapi.back4app.com";

let currentUser = null;
let showUserOnly = false;

// Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯Ø§ÙˆÙ„ Posts Ùˆ Comments ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
async function ensurePostsTable() {
  const schema = new Parse.Schema('Posts');
  try { await schema.get(); } catch(e) {
    await schema.save();
    await schema.addPointer('user', '_User');
    await schema.addString('content');
    await schema.addString('image_url');
    await schema.addNumber('likes');
  }
}

async function ensureCommentsTable() {
  const schema = new Parse.Schema('Comments');
  try { await schema.get(); } catch(e) {
    await schema.save();
    await schema.addPointer('user', '_User');
    await schema.addPointer('post', 'Posts');
    await schema.addString('content');
  }
}

// Ø¥Ø¶Ø§ÙØ© Ø£Ø¹Ù…Ø¯Ø© Ù…Ø®ØµØµØ© Users
async function ensureUserColumns() {
  const schema = new Parse.Schema('_User');
  try {
    await schema.get();
    try { await schema.addString('avatar'); } catch(e){}
    try { await schema.addString('bio'); } catch(e){}
  } catch(e){ console.error("Ø­Ø¯Ø« Ø®Ø·Ø£ Ù…Ø¹ Users:", e); }
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„Ø§Ø³Ù… ÙÙ‚Ø·
async function signUp(){
  const username = document.getElementById('su_username').value.trim();
  if(!username){ alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"); return; }

  const query = new Parse.Query(Parse.User);
  query.equalTo("username", username);
  try {
    const existing = await query.first();
    if(existing){ alert("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„. Ø§Ø®ØªØ± Ø§Ø³Ù…Ø§Ù‹ Ø¢Ø®Ø±."); return; }

    const user = new Parse.User();
    user.set("username", username);
    // ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± ÙˆÙ‡Ù…ÙŠØ© Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Parse
    user.set("password", "123456");
    await user.signUp();
    currentUser = user;
    localStorage.setItem('user', user.id);
    showProfile();
  } catch(error){
    console.error(error);
    alert("Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨:\nØ±Ù…Ø² Ø§Ù„Ø®Ø·Ø£: " + error.code + "\nØ§Ù„Ø±Ø³Ø§Ù„Ø©: " + error.message);
  }
}

// ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
function logout(){
  Parse.User.logOut();
  currentUser = null;
  localStorage.removeItem('user');
  document.getElementById('signupDiv').style.display='block';
  document.getElementById('profileDiv').style.display='none';
}

// ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©
async function editAvatar(){
  const url = prompt("Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©:");
  if(url){
    currentUser.set("avatar", url);
    await currentUser.save();
    document.getElementById('profileAvatar').src = url;
  }
}

// ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ø¨Ø°Ø©
async function editBio(){
  const bio = prompt("Ø§ÙƒØªØ¨ Ù†Ø¨Ø°Ø© Ø¹Ù†Ùƒ:");
  if(bio){
    currentUser.set("bio", bio);
    await currentUser.save();
    document.getElementById('profileBio').innerText = bio;
  }
}

// Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø´ÙˆØ±
async function createPost(){
  const content = document.getElementById('postContent').value;
  const image_url = document.getElementById('postImage').value;
  if(!currentUser){ alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"); return; }

  const Post = Parse.Object.extend("Posts");
  const post = new Post();
  post.set("user", currentUser);
  post.set("content", content);
  post.set("image_url", image_url);
  post.set("likes", 0);
  try {
    await post.save();
    document.getElementById('postContent').value='';
    document.getElementById('postImage').value='';
    if(showUserOnly) showUserFeed(currentUser); else showFeed();
  } catch(error){ console.error(error); }
}

// Ø¹Ø±Ø¶ Feed Ø¹Ø§Ù…
async function showFeed(){
  showUserOnly=false;
  document.getElementById('feedTitle').innerText="Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©";
  const Post = Parse.Object.extend("Posts");
  const query = new Parse.Query(Post);
  query.descending("createdAt");
  query.include("user");
  try {
    const results = await query.find();
    renderPosts(results);
  } catch(error){ console.error(error); }
}

// Ø¹Ø±Ø¶ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
async function showUserFeed(user){
  showUserOnly=true;
  document.getElementById('feedTitle').innerText="Ù…Ù†Ø´ÙˆØ±Ø§ØªÙŠ";
  const Post = Parse.Object.extend("Posts");
  const query = new Parse.Query(Post);
  query.equalTo("user", user);
  query.descending("createdAt");
  query.include("user");
  try { const results = await query.find(); renderPosts(results); } 
  catch(error){ console.error(error); }
}

// Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
function renderPosts(posts){
  const feedDiv = document.getElementById('feed');
  feedDiv.innerHTML = '';
  posts.forEach(post=>{
    const user = post.get("user");
    const username = user.get("username") || "Ù…Ø³ØªØ®Ø¯Ù…";
    const avatar = user.get("avatar") || "https://via.placeholder.com/30";
    const content = post.get("content");
    const image_url = post.get("image_url");
    const likes = post.get("likes") || 0;
    const div = document.createElement('div');
    div.className='post';
    div.innerHTML=`
      <span class="username"><img class="avatar" src="${avatar}">${username}</span>
      <p>${content}</p>
      ${image_url?`<img src="${image_url}">`:''}
      <button onclick="likePost('${post.id}', this)">ğŸ‘ Like ${likes}</button>
      <div class="comments">
        <input type="text" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ø§Ù‹..." onkeypress="if(event.key==='Enter'){addComment(event,'${post.id}')}">
      </div>
    `;
    feedDiv.appendChild(div);
  });
}

// Ù„Ø§ÙŠÙƒ
async function likePost(postId, btn){
  const Post = Parse.Object.extend("Posts");
  const query = new Parse.Query(Post);
  try{
    const post = await query.get(postId);
    post.increment("likes");
    await post.save();
    if(showUserOnly) showUserFeed(currentUser); else showFeed();
  } catch(error){ console.error(error); }
}

// Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚
async function addComment(e, postId){
  const text=e.target.value.trim();
  if(text==="") return;
  const Comment = Parse.Object.extend("Comments");
  const comment = new Comment();
  comment.set("user", currentUser);
  const Post = Parse.Object.extend("Posts");
  const post = new Post();
  post.id=postId;
  comment.set("post", post);
  comment.set("content", text);
  try { await comment.save(); e.target.value=''; if(showUserOnly) showUserFeed(currentUser); else showFeed(); } 
  catch(error){ console.error(error); }
}

// Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
window.onload=async()=>{
  await ensureUserColumns();
  await ensurePostsTable();
  await ensureCommentsTable();
  const user=Parse.User.current();
  if(user){ currentUser=user; showProfile(); } 
  else { document.getElementById('signupDiv').style.display='block'; }
}
</script>
</body>
</html>