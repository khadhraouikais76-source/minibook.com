<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mini Facebook Full</title>
<style>
  body { font-family: Arial, sans-serif; background:#f0f2f5; margin:0; padding:0; }
  header { background:#4267B2; color:white; padding:10px; text-align:center; font-size:24px; }
  main { padding:20px; max-width:600px; margin:auto; }
  input, button, textarea { width:100%; padding:10px; margin:5px 0; border-radius:5px; border:1px solid #ccc; }
  button { background:#4267B2; color:white; border:none; cursor:pointer; }
  button:hover { background:#365899; }
  .post { background:white; padding:10px; margin:10px 0; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
  .post img { max-width:100%; border-radius:5px; margin-top:5px; }
  .username { font-weight:bold; color:#4267B2; display:flex; align-items:center; gap:10px; }
  .avatar { width:30px; height:30px; border-radius:50%; object-fit:cover; }
  .comments { margin-top:10px; padding-left:20px; border-left:2px solid #eee; }
  .comment { margin-bottom:5px; }
  .profile { text-align:center; margin-bottom:20px; }
  .profile img { width:80px; height:80px; border-radius:50%; object-fit:cover; }
  .feed-title { margin-top:20px; font-size:18px; }
  a { color:#4267B2; text-decoration:none; }
</style>
</head>
<body>
<header>Mini Facebook Full</header>
<main>

<div id="signupDiv">
  <h2>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h2>
  <input type="text" id="su_username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" required>
  <input type="text" id="su_avatar" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
  <input type="text" id="su_bio" placeholder="Ù†Ø¨Ø°Ø© Ù‚ØµÙŠØ±Ø© Ø¹Ù†Ùƒ">
  <input type="password" id="su_password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
  <button onclick="signUp()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
  <p>Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <a href="#" onclick="showLogin()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a></p>
</div>

<div id="loginDiv" style="display:none;">
  <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
  <input type="text" id="li_username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" required>
  <input type="password" id="li_password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
  <button onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
  <p>Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <a href="#" onclick="showSignup()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</a></p>
</div>

<div id="profileDiv" style="display:none;">
  <div class="profile">
    <img id="profileAvatar" src="https://via.placeholder.com/80">
    <h2 id="profileName"></h2>
    <p id="profileBio"></p>
    <p><a href="#" onclick="showUserFeed(currentUser)">Ù…Ù†Ø´ÙˆØ±Ø§ØªÙŠ</a> | <a href="#" onclick="showFeed()">Feed Ø¹Ø§Ù…</a></p>
  </div>
  <h3>Ø£Ù†Ø´Ø¦ Ù…Ù†Ø´ÙˆØ±Ø§Ù‹</h3>
  <textarea id="postContent" placeholder="Ø§ÙƒØªØ¨ Ø´ÙŠØ¦Ø§Ù‹..."></textarea>
  <input type="text" id="postImage" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
  <button onclick="createPost()">Ù†Ø´Ø±</button>

  <h3 id="feedTitle" class="feed-title">Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª</h3>
  <div id="feed"></div>
  <button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>

<script src="https://unpkg.com/parse/dist/parse.min.js"></script>
<script>
Parse.initialize("ud7pjwTspM89k8GtFzMi4eppYn62HqXqNKQsbHsd"); // App ID
Parse.serverURL = 'https://parseapi.back4app.com';

let currentUser = null;
let showUserOnly = false;

function showSignup(){
  document.getElementById('signupDiv').style.display='block';
  document.getElementById('loginDiv').style.display='none';
  document.getElementById('profileDiv').style.display='none';
}
function showLogin(){
  document.getElementById('signupDiv').style.display='none';
  document.getElementById('loginDiv').style.display='block';
  document.getElementById('profileDiv').style.display='none';
}
function showProfile(){
  document.getElementById('signupDiv').style.display='none';
  document.getElementById('loginDiv').style.display='none';
  document.getElementById('profileDiv').style.display='block';
  document.getElementById('profileName').innerText = currentUser.get("username");
  document.getElementById('profileAvatar').src = currentUser.get("avatar") || 'https://via.placeholder.com/80';
  document.getElementById('profileBio').innerText = currentUser.get("bio") || '';
  showFeed();
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…Ø¹ Ø¹Ø±Ø¶ Ø³Ø¨Ø¨ Ø§Ù„Ø®Ø·Ø£ Ø¨Ø¯Ù‚Ø©
async function signUp(){
  const username = document.getElementById('su_username').value.trim();
  const password = document.getElementById('su_password').value;
  const avatar = document.getElementById('su_avatar').value;
  const bio = document.getElementById('su_bio').value;

  const query = new Parse.Query(Parse.User);
  query.equalTo("username", username);
  try {
    const existing = await query.first();
    if(existing){
      alert("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„. Ø§Ø®ØªØ± Ø§Ø³Ù…Ø§Ù‹ Ø¢Ø®Ø±.");
      return;
    }

    const user = new Parse.User();
    user.set("username", username);
    user.set("password", password);
    user.set("avatar", avatar);
    user.set("bio", bio);

    await user.signUp();
    currentUser = user;
    localStorage.setItem('user', user.id);
    showProfile();
  } catch(error){
    console.error(error);
    alert("Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨:\nØ±Ù…Ø² Ø§Ù„Ø®Ø·Ø£: " + error.code + "\nØ§Ù„Ø±Ø³Ø§Ù„Ø©: " + error.message);
  }
}

async function login(){
  const username = document.getElementById('li_username').value;
  const password = document.getElementById('li_password').value;

  try {
    const user = await Parse.User.logIn(username, password);
    currentUser = user;
    localStorage.setItem('user', user.id);
    showProfile();
  } catch(error){
    alert("Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©.\nØ§Ù„Ø±Ø³Ø§Ù„Ø©: " + error.message);
  }
}
function logout(){
  Parse.User.logOut();
  currentUser = null;
  localStorage.removeItem('user');
  showLogin();
}

async function createPost(){
  const content = document.getElementById('postContent').value;
  const image_url = document.getElementById('postImage').value;

  if(!currentUser) { alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"); return; }

  const Post = Parse.Object.extend("Posts");
  const post = new Post();
  post.set("user", currentUser);
  post.set("content", content);
  post.set("image_url", image_url);
  post.set("likes", 0);

  try {
    await post.save();
    document.getElementById('postContent').value='';
    document.getElementById('postImage').value='';
    if(showUserOnly) showUserFeed(currentUser); else showFeed();
  } catch(error){
    console.error(error);
    alert("Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù†Ø´ÙˆØ±:\n" + error.message);
  }
}

async function showFeed(){
  showUserOnly = false;
  document.getElementById('feedTitle').innerText = "Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©";

  const Post = Parse.Object.extend("Posts");
  const query = new Parse.Query(Post);
  query.descending("createdAt");
  query.include("user");

  try {
    const results = await query.find();
    renderPosts(results);
  } catch(error){
    console.error(error);
  }
}

async function showUserFeed(user){
  showUserOnly = true;
  document.getElementById('feedTitle').innerText = "Ù…Ù†Ø´ÙˆØ±Ø§ØªÙŠ";

  const Post = Parse.Object.extend("Posts");
  const query = new Parse.Query(Post);
  query.equalTo("user", user);
  query.descending("createdAt");
  query.include("user");

  try {
    const results = await query.find();
    renderPosts(results);
  } catch(error){
    console.error(error);
  }
}

function renderPosts(posts){
  const feedDiv = document.getElementById('feed');
  feedDiv.innerHTML = '';

  posts.forEach(post=>{
    const user = post.get("user");
    const username = user.get("username") || "Ù…Ø³ØªØ®Ø¯Ù…";
    const avatar = user.get("avatar") || "https://via.placeholder.com/30";
    const content = post.get("content");
    const image_url = post.get("image_url");
    const likes = post.get("likes") || 0;

    const div = document.createElement('div');
    div.className = 'post';
    div.innerHTML = `
      <span class="username"><img class="avatar" src="${avatar}">${username}</span>
      <p>${content}</p>
      ${image_url ? `<img src="${image_url}">` : ""}
      <button onclick="likePost('${post.id}', this)">ğŸ‘ Like ${likes}</button>
      <div class="comments">
        <input type="text" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ø§Ù‹..." onkeypress="if(event.key==='Enter'){addComment(event,'${post.id}')}">
      </div>
    `;
    feedDiv.appendChild(div);
  });
}

async function likePost(postId, btn){
  const Post = Parse.Object.extend("Posts");
  const query = new Parse.Query(Post);
  try {
    const post = await query.get(postId);
    post.increment("likes");
    await post.save();
    if(showUserOnly) showUserFeed(currentUser); else showFeed();
  } catch(error){
    console.error(error);
  }
}

async function addComment(e, postId){
  const text = e.target.value.trim();
  if(text==="") return;

  const Comment = Parse.Object.extend("Comments");
  const comment = new Comment();
  comment.set("user", currentUser);
  const Post = Parse.Object.extend("Posts");
  const post = new Post();
  post.id = postId;
  comment.set("post", post);
  comment.set("content", text);

  try {
    await comment.save();
    e.target.value='';
    if(showUserOnly) showUserFeed(currentUser); else showFeed();
  } catch(error){
    console.error(error);
  }
}

window.onload = async () => {
  const user = Parse.User.current();
  if(user){
    currentUser = user;
    showProfile();
  } else {
    showSignup();
  }
}
</script>
</body>
</html>