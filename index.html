<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>MiniBook</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: Arial; background:#f0f2f5; margin:0; }
.box { max-width:500px; margin:20px auto; background:#fff; padding:15px; border-radius:8px; }
input, textarea, button { width:100%; margin:5px 0; padding:10px; }
button { background:#1877f2; color:#fff; border:0; border-radius:5px; cursor:pointer; }
.post { border-top:1px solid #ddd; padding:10px 0; }
img { max-width:100%; border-radius:8px; margin-top:5px; }
#progressContainer { width:50px; height:50px; margin:10px 0; }
#progressCircle { stroke-dasharray: 157; stroke-dashoffset: 157; stroke:#1877f2; stroke-width:8; fill:none; transform:rotate(-90deg); transform-origin:center; transition: stroke-dashoffset 0.2s; }
#progressBg { stroke:#eee; stroke-width:8; fill:none; }
#preview { max-width:100%; margin-top:5px; border-radius:8px; display:none; }
#errorMsg { color:red; margin-top:5px; min-height:20px; }
</style>
</head>
<body>

<div id="auth" class="box">
  <h3>إنشاء حساب / دخول</h3>
  <input id="username" placeholder="اسم المستخدم">
  <input type="password" id="password" placeholder="كلمة المرور">
  <button onclick="login()">دخول / تسجيل</button>
  <p id="msg"></p>
</div>

<div id="app" class="box" style="display:none">
  <h3 id="welcome"></h3>
  <button onclick="logout()">تسجيل الخروج</button>
  <button onclick="deleteAccount()">حذف الحساب نهائيًا</button>
  <hr>
  <h4>نشر بوست</h4>
  <textarea id="postText" placeholder="ماذا تفكر؟"></textarea>
  <input type="file" id="postImage" accept=".jpg,.jpeg,.png,.gif" onchange="previewImage(this)">
  <img id="preview">
  <div id="progressContainer">
    <svg width="50" height="50">
      <circle id="progressBg" cx="25" cy="25" r="25"></circle>
      <circle id="progressCircle" cx="25" cy="25" r="25"></circle>
    </svg>
  </div>
  <div id="errorMsg"></div>
  <button id="publishBtn" onclick="addPost()">نشر</button>
  <hr>
  <h4>صفحتك الشخصية</h4>
  <div id="personalPosts"></div>
  <hr>
  <h4>الصفحة العامة</h4>
  <div id="allPosts"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyAiZsXpUfRB2s__oWRLjjT3yEgZQXOXIuI",
  authDomain: "book-ee927.firebaseapp.com",
  databaseURL: "https://book-ee927-default-rtdb.firebaseio.com",
  projectId: "book-ee927",
  storageBucket: "book-ee927.appspot.com",
});

const db = firebase.database();
const storage = firebase.storage();
let currentUser = localStorage.getItem("user");
const msg = document.getElementById("msg");
const errorMsg = document.getElementById("errorMsg");

/* تسجيل الدخول */
function login(){
  const name = document.getElementById("username").value.trim();
  const pass = document.getElementById("password").value.trim();
  if(!name || !pass) return msg.innerText="اكتب اسم وكلمة المرور";

  db.ref("users/"+name).get().then(snap=>{
    if(!snap.exists()){
      db.ref("users/"+name).set({name,password:pass});
      console.log("تم إنشاء الحساب:", name);
    }
    localStorage.setItem("user",name);
    start();
  }).catch(e=>{
    console.error(e);
    msg.innerText = "خطأ في الاتصال بقاعدة البيانات: " + e.message;
  });
}

/* بدء التطبيق */
function start(){
  currentUser = localStorage.getItem("user");
  if(!currentUser) return;
  document.getElementById("auth").style.display="none";
  document.getElementById("app").style.display="block";
  document.getElementById("welcome").innerText="مرحبا "+currentUser;
  loadPersonalPosts();
  loadAllPosts();
}

/* معاينة الصورة قبل الرفع */
function previewImage(input){
  const file = input.files[0];
  const preview = document.getElementById("preview");
  if(file && /\.(jpe?g|png|gif)$/i.test(file.name)){
    const reader = new FileReader();
    reader.onload = e => {
      preview.src = e.target.result;
      preview.style.display = "block";
      errorMsg.innerText = "";
    };
    reader.readAsDataURL(file);
  } else {
    preview.style.display = "none";
    errorMsg.innerText = "الملف يجب أن يكون صورة بصيغ: jpg, png, gif";
    input.value = "";
  }
}

/* ضغط الصورة قبل الرفع */
function compressImage(file, maxSize = 2 * 1024 * 1024){
  return new Promise(resolve => {
    if(file.size <= maxSize){
      resolve(file);
      return;
    }
    const img = new Image();
    const reader = new FileReader();
    reader.onload = e => { img.src = e.target.result; };
    img.onload = () => {
      const canvas = document.createElement("canvas");
      const scale = Math.sqrt(maxSize / file.size);
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img,0,0,canvas.width,canvas.height);
      canvas.toBlob(blob => resolve(blob), "image/jpeg", 0.8);
    };
    reader.readAsDataURL(file);
  });
}

/* تحديث Progress Circle */
function setProgress(percent){
  const circle = document.getElementById("progressCircle");
  const offset = 157 - (157 * percent / 100);
  circle.style.strokeDashoffset = offset;
}

/* إضافة بوست مع رفع الصورة */
async function addPost(){
  errorMsg.innerText = "";
  const btn = document.getElementById("publishBtn");
  btn.disabled = true;
  const text = document.getElementById("postText").value.trim();
  const fileInput = document.getElementById("postImage");
  const file = fileInput.files[0];
  const id = Date.now();

  if(!text && !file){
    errorMsg.innerText = "اكتب نص أو اختر صورة";
    btn.disabled = false;
    return;
  }

  let finalFile = file;

  if(file){
    try{
      finalFile = await compressImage(file);
      console.log("تم ضغط الصورة بنجاح:", finalFile);
    }catch(e){
      console.error("خطأ في ضغط الصورة:", e);
      errorMsg.innerText = "خطأ في ضغط الصورة: "+e.message;
      btn.disabled = false;
      setProgress(0);
      return;
    }
  }

  if(finalFile){
    const storageRef = storage.ref('posts/' + id + '_' + finalFile.name);
    const uploadTask = storageRef.put(finalFile);

    uploadTask.on('state_changed', 
      snapshot => {
        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
        console.log("تقدم الرفع:", progress.toFixed(2) + "%");
        setProgress(progress);
      }, 
      error => {
        console.error("خطأ أثناء رفع الصورة:", error);
        errorMsg.innerText = "خطأ أثناء رفع الصورة: " + error.message;
        btn.disabled = false;
        setProgress(0);
      }, 
      async () => {
        try{
          const url = await uploadTask.snapshot.ref.getDownloadURL();
          console.log("رابط الصورة:", url);
          savePost(text,url,id);
          btn.disabled = false;
          setProgress(0);
        }catch(e){
          console.error("خطأ عند الحصول على رابط الصورة:", e);
          errorMsg.innerText = "خطأ عند الحصول على رابط الصورة: " + e.message;
          btn.disabled = false;
          setProgress(0);
        }
      }
    );

  } else {
    try{
      savePost(text,"",id);
      btn.disabled = false;
      setProgress(0);
    }catch(e){
      console.error("خطأ عند حفظ البوست:", e);
      errorMsg.innerText = "خطأ عند حفظ البوست: "+e.message;
      btn.disabled = false;
      setProgress(0);
    }
  }
}

function savePost(text,img,id){
  db.ref("posts/"+id).set({user:currentUser,text,img});
  document.getElementById("postText").value="";
  document.getElementById("postImage").value="";
  document.getElementById("preview").style.display = "none";
  setProgress(0);
}

/* تحميل البوستات الشخصية */
function loadPersonalPosts(){
  db.ref("posts").on("value", snap => {
    let html = "";
    snap.forEach(p => {
      const d = p.val();
      if(d.user === currentUser){
        html += `<div class="post">
          <b>${d.user}</b>
          <p>${d.text}</p>
          ${d.img?`<img src="${d.img}">`:""}
          <button onclick="delPost('${p.key}')">حذف</button>
        </div>`;
      }
    });
    document.getElementById("personalPosts").innerHTML = html;
  });
}

/* تحميل كل البوستات */
function loadAllPosts(){
  db.ref("posts").on("value", snap => {
    let html = "";
    snap.forEach(p => {
      const d = p.val();
      html += `<div class="post">
        <b>${d.user}</b>
        <p>${d.text}</p>
        ${d.img?`<img src="${d.img}">`:""}
      </div>`;
    });
    document.getElementById("allPosts").innerHTML = html;
  });
}

/* حذف بوست */
function delPost(id){
  db.ref("posts/"+id).remove();
}

/* حذف الحساب نهائيًا */
function deleteAccount(){
  if(!confirm("هل تريد حذف حسابك نهائيًا؟ سيتم مسح كل البوستات")) return;
  db.ref("posts").once("value").then(snap=>{
    snap.forEach(p=>{
      if(p.val().user === currentUser){
        db.ref("posts/"+p.key).remove();
      }
    });
    db.ref("users/"+currentUser).remove();
    localStorage.clear();
    location.reload();
  });
}

/* تسجيل الخروج */
function logout(){
  localStorage.clear();
  location.reload();
}

start();
</script>
</body>
</html>