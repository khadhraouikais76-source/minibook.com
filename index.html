<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>MiniBook</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:sans-serif;background:#f0f2f5;margin:0}
.card{background:#fff;padding:15px;margin:10px;border-radius:8px}
input,textarea,button{width:100%;margin:5px 0;padding:10px}
button{background:#1877f2;color:#fff;border:none}
.post img{max-width:100%;border-radius:8px}
.hidden{display:none}
</style>
</head>
<body>

<div id="auth" class="card">
<h3>MiniBook</h3>
<input id="username" placeholder="اسم المستخدم">
<input id="password" type="password" placeholder="كلمة المرور">
<button onclick="register()">إنشاء حساب</button>
<button onclick="login()">تسجيل الدخول</button>
<p id="authMsg"></p>
</div>

<div id="app" class="hidden">
<div class="card">
<h3 id="welcome"></h3>
<input type="file" id="avatar">
<button onclick="uploadAvatar()">تغيير الصورة</button>
<button onclick="logout()">خروج</button>
</div>

<div class="card">
<textarea id="postText" placeholder="ماذا تفكر؟"></textarea>
<input type="file" id="postImage">
<button onclick="addPost()">نشر</button>
</div>

<div id="posts"></div>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, push, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAiZsXpUfRB2s__oWRLjjT3yEgZQXOXIuI",
  authDomain: "book-ee927.firebaseapp.com",
  databaseURL: "https://book-ee927-default-rtdb.firebaseio.com",
  projectId: "book-ee927",
  storageBucket: "book-ee927.appspot.com",
  messagingSenderId: "523457475998",
  appId: "1:523457475998:web:395114f92143b4f3d0128f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getDatabase();
const storage = getStorage();

window.register = async ()=>{
  const u=username.value.trim();
  const p=password.value;
  if(!u||!p)return authMsg.innerText="أدخل البيانات";
  try{
    await createUserWithEmailAndPassword(auth, u+"@minibook.com", p);
    await set(ref(db,"users/"+auth.currentUser.uid),{name:u});
  }catch(e){authMsg.innerText=e.message;}
};

window.login = async ()=>{
  try{
    await signInWithEmailAndPassword(auth, username.value+"@minibook.com", password.value);
  }catch(e){authMsg.innerText=e.message;}
};

window.logout = ()=>signOut(auth);

onAuthStateChanged(auth,u=>{
  if(u){
    auth.classList.add("hidden");
    app.classList.remove("hidden");
    welcome.innerText="مرحبا "+u.email.split("@")[0];
    loadPosts();
  }else{
    auth.classList.remove("hidden");
    app.classList.add("hidden");
  }
});

window.addPost = async ()=>{
  const text=postText.value;
  let img="";
  if(postImage.files[0]){
    const r=sRef(storage,"posts/"+Date.now());
    await uploadBytes(r,postImage.files[0]);
    img=await getDownloadURL(r);
  }
  await push(ref(db,"posts"),{
    user:auth.currentUser.uid,
    name:auth.currentUser.email.split("@")[0],
    text, img
  });
  postText.value="";
};

function loadPosts(){
  onValue(ref(db,"posts"),snap=>{
    posts.innerHTML="";
    snap.forEach(p=>{
      const d=p.val();
      const div=document.createElement("div");
      div.className="card post";
      div.innerHTML=`<b>${d.name}</b><p>${d.text}</p>${d.img?`<img src="${d.img}">`:""}
      ${d.user===auth.currentUser.uid?`<button onclick="deletePost('${p.key}')">حذف</button>`:""}`;
      posts.prepend(div);
    });
  });
}

window.deletePost=k=>remove(ref(db,"posts/"+k));

window.uploadAvatar=async()=>{
  const f=avatar.files[0];
  if(!f)return;
  const r=sRef(storage,"avatars/"+auth.currentUser.uid);
  await uploadBytes(r,f);
  const url=await getDownloadURL(r);
  await update(ref(db,"users/"+auth.currentUser.uid),{avatar:url});
};
</script>
</body>
</html>