<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>MiniBook</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: Arial; background:#f0f2f5; margin:0; }
.box { max-width:500px; margin:20px auto; background:#fff; padding:15px; border-radius:8px; }
input, textarea, button { width:100%; margin:5px 0; padding:10px; }
button { background:#1877f2; color:#fff; border:0; border-radius:5px; cursor:pointer; }
.post { border-top:1px solid #ddd; padding:10px 0; }
img { max-width:100%; border-radius:8px; margin-top:5px; display:block; }
#progressContainer { width:50px; height:50px; margin:10px 0; position:relative; }
#progressCircle { stroke-dasharray: 157; stroke-dashoffset: 157; stroke:#1877f2; stroke-width:8; fill:none; transform:rotate(-90deg); transform-origin:center; transition: stroke-dashoffset 0.2s; }
#progressBg { stroke:#eee; stroke-width:8; fill:none; }
#preview { max-width:100%; margin-top:5px; border-radius:8px; display:none; }
#statusMsg { color:red; font-weight:bold; margin-top:5px; min-height:20px; text-align:center; }
#progressText { position:absolute; width:100%; text-align:center; top:50%; left:0; transform:translateY(-50%); font-weight:bold; font-size:12px; }
</style>
</head>
<body>

<div id="auth" class="box">
  <h3>إنشاء حساب / دخول</h3>
  <input id="username" placeholder="اسم المستخدم">
  <input type="password" id="password" placeholder="كلمة المرور">
  <button onclick="login()">دخول / تسجيل</button>
  <p id="msg"></p>
</div>

<div id="app" class="box" style="display:none">
  <h3 id="welcome"></h3>
  <button onclick="logout()">تسجيل الخروج</button>
  <button onclick="deleteAccount()">حذف الحساب نهائيًا</button>
  <hr>
  <h4>نشر بوست</h4>
  <textarea id="postText" placeholder="ماذا تفكر؟"></textarea>
  <input type="file" id="postImage" accept=".jpg,.jpeg,.png,.gif" onchange="previewImage(this)">
  <img id="preview">
  <div id="progressContainer">
    <svg width="50" height="50">
      <circle id="progressBg" cx="25" cy="25" r="25"></circle>
      <circle id="progressCircle" cx="25" cy="25" r="25"></circle>
    </svg>
    <div id="progressText">0%</div>
  </div>
  <div id="statusMsg">ارفع صورة أو اكتب نص</div>
  <button id="publishBtn" onclick="addPost()">نشر</button>
  <hr>
  <h4>صفحتك الشخصية</h4>
  <div id="personalPosts"></div>
  <hr>
  <h4>الصفحة العامة</h4>
  <div id="allPosts"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyAiZsXpUfRB2s__oWRLjjT3yEgZQXOXIuI",
  authDomain: "book-ee927.firebaseapp.com",
  databaseURL: "https://book-ee927-default-rtdb.firebaseio.com",
  projectId: "book-ee927",
  storageBucket: "book-ee927.appspot.com",
});

const db = firebase.database();
const storage = firebase.storage();
let currentUser = localStorage.getItem("user");
const msg = document.getElementById("msg");
const statusMsg = document.getElementById("statusMsg");
const progressText = document.getElementById("progressText");

/* تسجيل الدخول */
function login(){
  const name = document.getElementById("username").value.trim();
  const pass = document.getElementById("password").value.trim();
  if(!name || !pass){
    msg.innerText="اكتب اسم وكلمة المرور";
    return;
  }
  db.ref("users/"+name).get().then(snap=>{
    if(!snap.exists()){
      db.ref("users/"+name).set({name,password:pass});
    }
    localStorage.setItem("user",name);
    start();
  }).catch(e=>{
    console.error(e);
    msg.innerText = "خطأ في الاتصال بقاعدة البيانات: " + e.message;
  });
}

/* بدء التطبيق */
function start(){
  currentUser = localStorage.getItem("user");
  if(!currentUser) return;
  document.getElementById("auth").style.display="none";
  document.getElementById("app").style.display="block";
  document.getElementById("welcome").innerText="مرحبا "+currentUser;
  loadPersonalPosts();
  loadAllPosts();
}

/* معاينة الصورة */
function previewImage(input){
  const file = input.files[0];
  const preview = document.getElementById("preview");
  const maxSize = 2*1024*1024;
  if(!file){
    preview.style.display = "none";
    statusMsg.innerText = "لم يتم اختيار أي صورة";
    statusMsg.style.color="red";
    return;
  }
  if(!/\.(jpe?g|png|gif)$/i.test(file.name)){
    preview.style.display = "none";
    statusMsg.innerText = "صيغة الصورة غير مدعومة (jpg, png, gif)";
    statusMsg.style.color="red";
    input.value = "";
    return;
  }
  if(file.size > maxSize){
    preview.style.display = "none";
    statusMsg.innerText = "الملف كبير جدًا، الحد الأقصى 2MB";
    statusMsg.style.color="red";
    input.value = "";
    return;
  }
  const reader = new FileReader();
  reader.onload = e=>{
    preview.src = e.target.result;
    preview.style.display = "block";
    statusMsg.innerText = "تم اختيار الصورة بنجاح";
    statusMsg.style.color="green";
  };
  reader.readAsDataURL(file);
}

/* تحديث البروغرس */
function setProgress(percent){
  const circle = document.getElementById("progressCircle");
  const offset = 157 - (157*percent/100);
  circle.style.strokeDashoffset = offset;
  progressText.innerText = percent.toFixed(0)+"%";
}

/* نشر البوست */
async function addPost() {
  const btn = document.getElementById("publishBtn");
  btn.disabled = true;
  const text = document.getElementById("postText").value.trim();
  const fileInput = document.getElementById("postImage");
  const file = fileInput.files[0];
  const id = Date.now();

  if (!text && !file) {
    statusMsg.innerText = "اكتب نص أو ارفع صورة";
    statusMsg.style.color = "red";
    btn.disabled = false;
    return;
  }

  // كل شيء جيد حتى الآن
  statusMsg.innerText = "لا يوجد مشكلة";
  statusMsg.style.color = "green";

  if (file) {
    // تحقق من الصيغة والحجم
    if (!/\.(jpe?g|png|gif)$/i.test(file.name)) {
      statusMsg.innerText = "صيغة الصورة غير مدعومة (jpg, png, gif)";
      statusMsg.style.color = "red";
      btn.disabled = false;
      return;
    }
    if (file.size > 2*1024*1024) {
      statusMsg.innerText = "الملف كبير جدًا، الحد الأقصى 2MB";
      statusMsg.style.color = "red";
      btn.disabled = false;
      return;
    }

    const safeName = file.name.replace(/\s+/g, "_").replace(/[^a-zA-Z0-9_\.-]/g, "");
    const storageRef = firebase.storage().ref('posts/' + id + "_" + safeName);

    try {
      const uploadTask = storageRef.put(file);

      uploadTask.on('state_changed', snapshot => {
        if(snapshot.totalBytes > 0){
          const progress = (snapshot.bytesTransferred/snapshot.totalBytes)*100;
          setProgress(progress);
          statusMsg.innerText = "جاري رفع الصورة: " + progress.toFixed(0) + "%";
          statusMsg.style.color = "black";
        }
      });

      // انتظار انتهاء الرفع
      await uploadTask;
      const url = await storageRef.getDownloadURL();
      savePost(text, url, id);
      statusMsg.innerText = "تم النشر بنجاح";
      statusMsg.style.color = "green";
      setProgress(100);
      setTimeout(()=>setProgress(0),1000);
      btn.disabled = false;

    } catch(e){
      console.error(e);
      statusMsg.innerText = "فشل الرفع: " + e.message;
      statusMsg.style.color = "red";
      setProgress(0);
      btn.disabled = false;
    }

  } else {
    // نص فقط
    savePost(text,"",id);
    statusMsg.innerText="تم النشر بنجاح (نص فقط)";
    statusMsg.style.color="green";
    setProgress(100);
    setTimeout(()=>setProgress(0),1000);
    btn.disabled=false;
  }
}

/* حفظ البوست */
function savePost(text,img,id){
  db.ref("posts/"+id).set({user:currentUser,text,img});
  document.getElementById("postText").value="";
  document.getElementById("postImage").value="";
  document.getElementById("preview").style.display="none";
  setProgress(0);
}

/* تحميل البوستات */
function loadPersonalPosts(){
  db.ref("posts").on("value",snap=>{
    let html="";
    snap.forEach(p=>{
      const d=p.val();
      if(d.user===currentUser){
        html+=`<div class="post"><b>${d.user}</b><p>${d.text}</p>${d.img?`<img src="${d.img}">`:""}<button onclick="delPost('${p.key}')">حذف</button></div>`;
      }
    });
    document.getElementById("personalPosts").innerHTML=html;
  });
}

function loadAllPosts(){
  db.ref("posts").on("value",snap=>{
    let html="";
    snap.forEach(p=>{
      const d=p.val();
      html+=`<div class="post"><b>${d.user}</b><p>${d.text}</p>${d.img?`<img src="${d.img}">`:""}</div>`;
    });
    document.getElementById("allPosts").innerHTML=html;
  });
}

function delPost(id){ db.ref("posts/"+id).remove(); }

function deleteAccount(){
  if(!confirm("هل تريد حذف حسابك نهائيًا؟ سيتم مسح كل البوستات")) return;
  db.ref("posts").once("value").then(snap=>{
    snap.forEach(p=>{
      if(p.val().user===currentUser) db.ref("posts/"+p.key).remove();
    });
    db.ref("users/"+currentUser).remove();
    localStorage.clear();
    location.reload();
  });
}

function logout(){ localStorage.clear(); location.reload(); }

start();
</script>
</body>
</html>